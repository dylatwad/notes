<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=500">
  <title>Call Notes</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="data/notes.png">
  <style>
    body {
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #3b82f6 0%, #222c37 100%);
      color: #f3f3f3;
      min-height: 100vh;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 0.97em;
      overflow: hidden;
    }
    html {
      overflow: hidden;
    }
    .container {
      background: rgba(42,54,71,0.45);
      border-radius: 32px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      padding: 32px 32px 12px 32px;
      min-width: 550px;
      width: clamp(550px, 60vw, 480px);
      max-width: 96vw;
      position: relative;
      animation: fadeIn 0.7s;
      border: 1.5px solid rgba(255,255,255,0.18);
      backdrop-filter: blur(18px) saturate(160%) contrast(120%);
      -webkit-backdrop-filter: blur(18px) saturate(160%) contrast(120%);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    h1 {
      text-align: center;
      margin-bottom: 18px;
      font-size: 1.35em;
      font-weight: 700;
      letter-spacing: 1px;
      color: #fff;
      text-shadow: 0 2px 8px #0003;
    }
    label {
      display: block;
      margin-top: 13px;
      margin-bottom: 4px;
      font-weight: 600;
      color: #a5b4fc;
      letter-spacing: 0.5px;
      font-size: 0.98em;
    }
    input, select, textarea, button {
      border-radius: 18px !important;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: none;
      font-size: 0.98em;
      margin-bottom: 4px;
      background: rgba(255,255,255,0.55);
      color: #1b2532;
      box-sizing: border-box;
      transition: box-shadow 0.2s, border 0.2s, background 0.2s, color 0.2s;
      outline: none;
      box-shadow: 0 1px 6px #0001;
      border: 1.5px solid rgba(60,60,100,0.08);
    }
    input:focus, select:focus, textarea:focus {
      box-shadow: 0 0 0 2px #3b82f6, 0 1px 6px #0001;
      border: 1.5px solid #3b82f6;
      background: rgba(255,255,255,0.85);
      color: #181f2a;
    }
    select {
      cursor: pointer;
      background: rgba(255,255,255,0.55) url('data:image/svg+xml;utf8,<svg fill="%231b2532" height="20" viewBox="0 0 20 20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M7.293 7.293a1 1 0 011.414 0L10 8.586l1.293-1.293a1 1 0 111.414 1.414l-2 2a1 1 0 01-1.414 0l-2-2a1 1 0 010-1.414z"/></svg>') no-repeat right 12px center/18px 18px;
      appearance: none;
    }
    textarea {
      min-height: 330px;
      resize: vertical;
      margin-top: 10px;
      font-family: 'Fira Mono', 'Consolas', monospace;
      font-size: 0.97em;
      background: rgba(255,255,255,0.55);
      color: #1b2532;
      border: 1.5px solid rgba(60,60,100,0.08);
      box-shadow: 0 2px 8px #0001;
    }
    button {
      background: linear-gradient(90deg, #3b82f6 0%, #6366f1 100%);
      color: #fff;
      border: none;
      border-radius: 18px;
      padding: 10px 0;
      font-size: 1em;
      font-weight: 700;
      width: 100%;
      margin-top: 14px;
      cursor: pointer;
      box-shadow: 0 2px 8px #0002;
      transition: background 0.2s, transform 0.1s;
      letter-spacing: 0.5px;
    }
    button:active {
      transform: scale(0.98);
    }
    button.copied {
      background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%);
    }
    button.clear {
      background: linear-gradient(90deg, #f87171 0%, #ef4444 100%) !important;
      color: #fff !important;
      transition: background 0.2s, color 0.2s;
    }
    button.undo {
      background: linear-gradient(90deg, #f87171 0%, #ef4444 100%) !important;
      color: #fff !important;
      transition: background 0.2s, color 0.2s;
    }
    .note-label {
      margin-top: 22px;
      font-weight: 600;
      color: #a5b4fc;
      font-size: 1.08em;
    }
    .footer {
      text-align: center;
      margin-top: 22px;
      color: #a5b4fc;
      font-size: 0.92em;
      letter-spacing: 0.5px;
      border-radius: 18px;
    }
    .field-group {
      display: flex;
      gap: 16px;
    }
    .field-group > div {
      border-radius: 18px;
    }
    /* Custom iOS-style checkbox */
    input[type="checkbox"] {
      appearance: none;
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 8px;
      border: 2px solid #a5b4fc;
      background: rgba(255,255,255,0.7);
      transition: border-color 0.2s, background 0.2s;
      position: relative;
      cursor: pointer;
      outline: none;
      box-shadow: 0 1px 4px #0001;
      margin-right: 4px;
      display: inline-block;
      vertical-align: middle;
    }
    input[type="checkbox"]:checked {
      background: linear-gradient(90deg, #6366f1 0%, #3b82f6 100%);
      border-color: #6366f1;
    }
    input[type="checkbox"]:checked::after {
      content: '';
      display: block;
      position: absolute;
      left: 6px;
      top: 2px;
      width: 7px;
      height: 13px;
      border: solid #fff;
      border-width: 0 3px 3px 0;
      border-radius: 2px;
      transform: rotate(45deg);
    }
    input[type="checkbox"]:focus {
      box-shadow: 0 0 0 2px #a5b4fc44;
      border-color: #6366f1;
    }
    .input-icon-group label {
      margin-bottom: 2px;
      font-weight: 600;
      color: #a5b4fc;
      letter-spacing: 0.5px;
      font-size: 0.98em;
    }
    .input-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #3b82f6;
      opacity: 0.8;
      font-size: 1.1em;
      pointer-events: none;
      z-index: 2;
    }
    .input-icon-group input {
      padding-left: 38px !important;
    }
    .input-icon-group > div {
      position: relative;
    }
    @media (max-width: 600px) {
      .container {
        min-width: unset;
        width: 99vw;
        padding: 10px 2px 10px 2px;
      }
      h1 {
        font-size: 1em;
      }
      textarea {
        min-height: 120px;
      }
    }
    .input-icon-group select {
      padding-left: 44px !important;
      padding-right: 38px !important;
      background: rgba(255,255,255,0.55);
      color: #1b2532;
      border: none;
      font-size: 0.98em;
      margin-bottom: 4px;
      box-sizing: border-box;
      border-radius: 18px !important;
      box-shadow: 0 1px 6px #0001;
      border: 1.5px solid rgba(60,60,100,0.08);
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
    }
    .input-icon-group select:focus {
      box-shadow: 0 0 0 2px #3b82f6, 0 1px 6px #0001;
      border: 1.5px solid #3b82f6;
      background: rgba(255,255,255,0.85);
      color: #181f2a;
    }
    .input-select-arrow {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: #3b82f6;
      opacity: 0.7;
      font-size: 1em;
      pointer-events: none;
      z-index: 2;
    }
    .enter-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #3b82f6;
      opacity: 0.7;
      font-size: 1.1em;
      pointer-events: none;
      z-index: 2;
    }
    .custom-dropdown {
      position: relative;
      width: 100%;
      background: rgba(255,255,255,0.55);
      border-radius: 18px;
      box-shadow: 0 1px 6px #0001;
      border: 1.5px solid rgba(60,60,100,0.08);
      cursor: pointer;
      font-size: 0.98em;
      margin-bottom: 4px;
      min-width: 0;
    }
    .selected-option {
      padding: 10px 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: #1b2532;
    }
    .dropdown-options {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      background: #fff;
      border-radius: 0 0 18px 18px;
      box-shadow: 0 4px 16px #0002;
      z-index: 10;
      max-height: 260px;
      overflow-y: auto;
    }
    .dropdown-option {
      padding: 10px 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: #1b2532;
      cursor: pointer;
      transition: background 0.15s;
    }
    .dropdown-option:hover, .dropdown-option.active {
      background: #e0e7ff;
    }
    .floating-clear-btn, .floating-undo-btn {
      position: absolute;
      top: 18px;
      right: 24px;
      z-index: 100;
      background: rgba(42,54,71,0.85);
      border-radius: 50%;
      box-shadow: 0 2px 8px #0002;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
      border: 1.5px solid rgba(255,255,255,0.18);
    }
    .floating-clear-btn:hover, .floating-undo-btn:hover {
      background: #ef4444;
      color: #fff;
    }
    .floating-clear-btn i, .floating-undo-btn i {
      font-size: 1.3em;
      color: #fff;
      pointer-events: none;
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
  <div class="container">
    <form id="noteForm" autocomplete="off">
      <div class="field-group">
        <div class="input-icon-group" style="flex:1;min-width:0;">
          <label for="name"><span>Full Name</span></label>
          <div style="position:relative;">
            <i class="fa-solid fa-user input-icon"></i>
            <input type="text" id="name" required placeholder="John Doe">
          </div>
        </div>
        <div class="input-icon-group" style="flex:1;min-width:0;">
          <label for="contact"><span>Contact Number</span></label>
          <div style="position:relative;">
            <i class="fa-solid fa-phone input-icon"></i>
            <input type="text" id="contact" required placeholder="(555) 555-5555">
          </div>
        </div>
      </div>
      <div class="input-icon-group">
        <label for="confirmation"><span>Confirmation Number</span></label>
        <div style="position:relative;">
          <i class="fa-solid fa-hashtag input-icon"></i>
          <input type="text" id="confirmation" required placeholder="49123491123">
        </div>
      </div>
      <div class="input-icon-group">
        <label for="reason"><span>Quick Notes</span></label>
        <div id="reason-flex-group" style="position:relative;display:flex;gap:12px;align-items:center;">
          <div style="flex:1;min-width:0;position:relative;">
            <div id="customDropdown" class="custom-dropdown" tabindex="0">
              <div class="selected-option" id="selectedOption">
                <i class="fa-solid fa-note-sticky" style="color:#3b82f6;"></i> <span>New Note</span>
              </div>
              <div class="dropdown-options" id="dropdownOptions" style="display:none;">
                <div class="dropdown-option" data-value="New Note"><i class="fa-solid fa-note-sticky" style="color:#3b82f6;"></i> New Note</div>
                <div class="dropdown-option" data-value="Modify Reservation"><i class="fa-solid fa-pen-to-square" style="color:#3b82f6;"></i> Modify Reservation</div>
                <div class="dropdown-option" data-value="Too Late to Cancel"><i class="fa-solid fa-clock" style="color:#3b82f6;"></i> Too Late to Cancel</div>
                <div class="dropdown-option" data-value="Request Receipt"><i class="fa-solid fa-file-invoice" style="color:#3b82f6;"></i> Request Receipt</div>
                <div class="dropdown-option" data-value="Hotel Complaint"><i class="fa-solid fa-triangle-exclamation" style="color:#3b82f6;"></i> Hotel Complaint</div>
                <div class="dropdown-option" data-value="Incorrectly Billed"><i class="fa-solid fa-money-bill-wave" style="color:#3b82f6;"></i> Incorrectly Billed</div>
                <div class="dropdown-option" data-value="Deposit Issue"><i class="fa-solid fa-piggy-bank" style="color:#3b82f6;"></i> Deposit Issue</div>
              </div>
            </div>
            <input type="hidden" id="reason" value="New Note">
          </div>
          <div id="customReasonWrapper" style="flex:1;min-width:0;position:relative;display:inline-block;">
            <span id="customReasonIconInput" style="width:100%;display:flex;align-items:center;">
              <i class="fa-solid fa-question-circle input-icon"></i>
              <input type="text" id="customReason" placeholder="Reason For Call" style="width:100%;" />
            </span>
          </div>
        </div>
      </div>
      <div class="input-icon-group">
        <label for="hotelResponse"><span>What Happened?</span></label>
        <div style="position:relative;">
          <i class="fa-solid fa-comment-dots input-icon"></i>
          <input type="text" id="hotelResponse" placeholder="Tip: Press Enter to add multiple responses">
          <span class="enter-icon" id="enterIcon" title="Press Enter to add" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);color:#3b82f6;opacity:0.7;font-size:1.1em;pointer-events:none;z-index:2;display:none;">
            <i class="fa-solid fa-arrow-turn-down"></i>
          </span>
        </div>
      </div>
      <div class="input-icon-group">
        <label for="hotelContact"><span>Hotel Contact</span></label>
        <div style="position:relative;">
          <i class="fa-solid fa-user-tie input-icon"></i>
          <input type="text" id="hotelContact" placeholder="Manager Bill">
        </div>
      </div>
      <div style="margin: 6px 0 0 0; display: flex; align-items: center; gap: 8px; justify-content: center;">
        <input type="checkbox" id="hotelUnreachable" style="width:16px;height:16px;">
        <label for="hotelUnreachable" style="margin:0;font-weight:400;font-size:0.97em;cursor:pointer;">Could not reach hotel</label>
      </div>
      <textarea id="note"></textarea>

      <button type="button" id="copyBtn">Copy to Clipboard</button>
    </form>
    <div class="footer">
      <a href="mailto:dylatwad@gmail.com" style="color:#a5b4fc;text-decoration:underline dotted 1.5px;opacity:0.7;font-size:0.98em;transition:opacity 0.2s;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.7">dylatwad@gmail.com</a>
    </div>
    <!-- Floating Clear/Undo Button -->
    <div id="floatingClearBtn" class="floating-clear-btn" title="Clear form">
      <i class="fa-solid fa-xmark"></i>
    </div>
    <div id="floatingUndoBtn" class="floating-undo-btn" title="Undo clear" style="display:none;">
      <i class="fa-solid fa-rotate-left"></i>
    </div>
  </div>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('sw.js');
      });
    }

    const nameInput = document.getElementById('name');
    const contactInput = document.getElementById('contact');
    const confirmationInput = document.getElementById('confirmation');
    const reasonSelect = document.getElementById('reason');
    const hotelResponseInput = document.getElementById('hotelResponse');
    const hotelContactInput = document.getElementById('hotelContact');
    const hotelUnreachableCheckbox = document.getElementById('hotelUnreachable');
    const noteArea = document.getElementById('note');
    const copyBtn = document.getElementById('copyBtn');
    const customReasonInput = document.getElementById('customReason');
    const customDropdown = document.getElementById('customDropdown');
    const dropdownOptions = document.getElementById('dropdownOptions');
    const selectedOption = document.getElementById('selectedOption');
    const reasonInput = document.getElementById('reason');
    const floatingClearBtn = document.getElementById('floatingClearBtn');
    const floatingUndoBtn = document.getElementById('floatingUndoBtn');
    let responseLines = [];
    let responseLinesBackup = [];
    let lastFormStateFloating = null;
    let lastResponseLinesFloating = [];

    function updateCustomReasonVisibility() {
      const customReasonWrapper = document.getElementById('customReasonWrapper');
      if (reasonSelect.value === 'New Note') {
        customReasonWrapper.style.display = 'inline-block';
        reasonSelect.style.flex = 'unset';
      } else {
        customReasonWrapper.style.display = 'none';
        reasonSelect.style.flex = '1';
      }
    }
    reasonSelect.addEventListener('change', updateCustomReasonVisibility);
    updateCustomReasonVisibility();
    reasonSelect.addEventListener('change', updateCustomReasonVisibility);
    updateCustomReasonVisibility();

    // Store multiple responses
    hotelResponseInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const val = hotelResponseInput.value.trim();
        if (val) {
          responseLines.push(val);
          hotelResponseInput.value = '';
          hotelResponseInput.style.outline = '2.5px solid #22c55e';
          setTimeout(() => {
            hotelResponseInput.style.outline = '';
          }, 400);
          updateNote();
        }
      }
    });

    hotelResponseInput.addEventListener('input', function() {
      const enterIcon = document.getElementById('enterIcon');
      if (hotelResponseInput.value.trim()) {
        enterIcon.style.display = 'inline';
      } else {
        enterIcon.style.display = 'none';
      }
      updateNote();
    });

    function getHotelContactLine() {
      const contact = hotelContactInput.value.trim();
      const unreachable = hotelUnreachableCheckbox.checked;
      if (contact) {
        return `– Spoke with ${contact} at the hotel\n`;
      } else if (unreachable) {
        return `– Attempted to reach hotel unsuccessfully.\n`;
      } else {
        return "";
      }
    }

    function getBottomTemplate(reason, _hotelResponse, name) {
      let allResponses = responseLines.slice();
      if (hotelResponseInput.value.trim()) {
        allResponses.push(hotelResponseInput.value.trim());
      }
      let customReason = customReasonInput.value.trim();
      let responseLine = allResponses.length ? allResponses.map(r => `– ${r}\n`).join('') : '';
      let modifyLine = responseLine;
      let complaintLine = responseLine || '– Documented complaint details\n';
      const hotelContactLine = getHotelContactLine();
      const sorryLine = '– Gave sorry/empathy statement\n';
      const templates = {
        "Too Late to Cancel":
          `– ${name} called and stated that they needed to cancel a reservation\n${sorryLine}– ${name} provided confirmation number and reservation was verified\n${hotelContactLine}${responseLine}– Advised ${name} of above\n– Provided ${name} CR ticket number\n– Sent to member web for hotel records\n– Closed ticket`,
        "Modify Reservation":
          `– ${name} called to modify reservation\n${sorryLine}– Provided confirmation number and verified reservation\n${hotelContactLine}${modifyLine}– Advised ${name} accordingly\n– Provided CR ticket number\n– Closed ticket`,
        "Request Receipt":
          hotelContactLine
            ? `– ${name} requested receipt for stay\n${sorryLine}– Verified ${name.toLowerCase()} information and stay details\n${hotelContactLine}${responseLine}– Sent receipt to ${name.toLowerCase()}'s email address on file\n– Provided CR ticket number\n– Closed ticket`
            : `– ${name} requested receipt for stay\n${sorryLine}– Verified ${name.toLowerCase()} information and stay details\n– Sent receipt to ${name.toLowerCase()}'s email address on file\n– Provided CR ticket number\n– Closed ticket`,
        "Hotel Complaint":
          `– ${name} called with complaint about hotel stay\n${sorryLine}– Listened to ${name.toLowerCase()}'s concerns\n${complaintLine}${hotelContactLine}– Advised ${name} of outcome\n– Provided CR ticket number\n– Closed ticket`,
        "Incorrectly Billed":
          `– ${name} called and stated they had been incorrectly billed for a recent stay\n${sorryLine}– ${name} provided confirmation number and reservation was verified\n${hotelContactInput.value.trim() ? `– Spoke with ${hotelContactInput.value.trim()} at hotel\n` : hotelUnreachableCheckbox.checked ? `– Attempted to reach hotel unsuccessfully.\n` : ''}${responseLine}– Advised ${name} of above\n– Sent to member web for hotel records\n– Closed ticket`,
        "Deposit Issue":
          `– ${name} called and stated that they did not receive their deposit back for their recent stay\n${sorryLine}– ${name} provided confirmation number and reservation was verified\n${getHotelContactLine()}${responseLine}– Advised ${name} of above and explained timeline for banks to release funds\n– Sent to member web for hotel response\n– Closed ticket`,
        "New Note":
          `${sorryLine}${responseLine}${hotelContactLine}– Closed ticket`,
        "":
          `${sorryLine}${responseLine}${hotelContactLine}– Closed ticket`
      };
      return templates[reason] || templates[""];
    }

    function updateNote() {
      const name = nameInput.value.trim() || 'Guest';
      const contact = contactInput.value.trim();
      const confirmation = confirmationInput.value.trim();
      let reason = reasonSelect.value;
      let customReason = customReasonInput.value.trim();
      // If New Note is selected, use customReason for Reason for Call
      if (reason === 'New Note') {
        reason = customReason || '';
      }
      const top = `Guest Name: ${name}\nBest Callback Number: ${contact}\nConfirmation Number: ${confirmation}\nReason For Call: ${reason}\n`;
      const bottom = getBottomTemplate(reasonSelect.value, '', name);
      noteArea.value = `${top}\n${bottom}`;
    }

    // Auto-update note on input
    [nameInput, confirmationInput, reasonSelect, hotelResponseInput, hotelContactInput, hotelUnreachableCheckbox].forEach(el => {
      el.addEventListener('input', updateNote);
      el.addEventListener('change', updateNote);
    });
    [customReasonInput].forEach(el => {
      el.addEventListener('input', updateNote);
      el.addEventListener('change', updateNote);
    });

    // Phone number formatting
    const formatPhoneNumber = (value) => {
      // Remove all non-digit characters
      const digits = value.replace(/\D/g, '');
      if (digits.length === 0) return '';
      if (digits.length < 4) return `(${digits}`;
      if (digits.length < 7) return `(${digits.slice(0,3)}) ${digits.slice(3)}`;
      return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6,10)}`;
    };

    contactInput.addEventListener('input', (e) => {
      const cursor = contactInput.selectionStart;
      const prev = contactInput.value;
      const formatted = formatPhoneNumber(prev);
      contactInput.value = formatted;
      // Try to keep cursor at end for most cases
      contactInput.setSelectionRange(formatted.length, formatted.length);
      updateNote();
    });

    // Mutually exclusive logic
    hotelContactInput.addEventListener('input', () => {
      if (hotelContactInput.value.trim()) {
        hotelUnreachableCheckbox.checked = false;
      }
      // Always keep checkbox enabled
    });
    hotelUnreachableCheckbox.addEventListener('change', () => {
      if (hotelUnreachableCheckbox.checked) {
        hotelContactInput.value = '';
      }
      // Always keep contact input enabled
      updateNote();
    });

    // Allow manual edits to note
    noteArea.addEventListener('input', () => {});

    let clearTimeoutId = null;
    let isClearMode = false;
    let lastFormState = null;
    let isUndoMode = false;

    function getFormState() {
      return {
        name: nameInput.value,
        contact: contactInput.value,
        confirmation: confirmationInput.value,
        hotelResponse: hotelResponseInput.value,
        hotelContact: hotelContactInput.value,
        hotelUnreachable: hotelUnreachableCheckbox.checked,
        reason: reasonSelect.value,
        customReason: customReasonInput.value,
        note: noteArea.value
      };
    }
    function setFormState(state) {
      nameInput.value = state.name;
      contactInput.value = state.contact;
      confirmationInput.value = state.confirmation;
      hotelResponseInput.value = state.hotelResponse;
      hotelContactInput.value = state.hotelContact;
      hotelUnreachableCheckbox.checked = state.hotelUnreachable;
      reasonSelect.value = state.reason;
      customReasonInput.value = state.customReason !== undefined ? state.customReason : '';
      updateCustomReasonVisibility();
      updateNote();
    }

    function resetCopyBtn() {
      copyBtn.classList.remove('copied');
      copyBtn.innerHTML = 'Copy to Clipboard';
    }

    copyBtn.addEventListener('click', () => {
      noteArea.select();
      document.execCommand('copy');
      copyBtn.classList.add('copied');
      copyBtn.textContent = 'Copied!';
      // Backup and clear the responseLines buffer, but do NOT update the note
      responseLinesBackup = responseLines.slice();
      responseLines = [];
      setTimeout(() => {
        resetCopyBtn();
      }, 400);
    });

    floatingClearBtn.addEventListener('click', () => {
      lastFormStateFloating = getFormState();
      lastResponseLinesFloating = responseLines.slice();
      // Clear all text fields
      nameInput.value = '';
      contactInput.value = '';
      confirmationInput.value = '';
      hotelResponseInput.value = '';
      hotelContactInput.value = '';
      hotelUnreachableCheckbox.checked = false;
      customReasonInput.value = '';
      responseLines = [];
      updateNote();
      floatingClearBtn.style.display = 'none';
      floatingUndoBtn.style.display = 'flex';
    });

    floatingUndoBtn.addEventListener('click', () => {
      if (lastFormStateFloating) {
        setFormState(lastFormStateFloating);
        responseLines = lastResponseLinesFloating.slice();
        updateNote();
      }
      floatingUndoBtn.style.display = 'none';
      floatingClearBtn.style.display = 'flex';
    });

    // Show/hide floating clear button based on form state
    function updateFloatingClearBtnVisibility() {
      const isFilled = nameInput.value || contactInput.value || confirmationInput.value || hotelResponseInput.value || hotelContactInput.value || customReasonInput.value || responseLines.length;
      if (isFilled && floatingUndoBtn.style.display !== 'flex') {
        floatingClearBtn.style.display = 'flex';
      } else {
        floatingClearBtn.style.display = 'none';
      }
    }

    // Update visibility on input/change
    [nameInput, contactInput, confirmationInput, reasonSelect, hotelResponseInput, hotelContactInput, hotelUnreachableCheckbox, customReasonInput, noteArea].forEach(el => {
      el.addEventListener('input', () => {
        // If undo is showing, revert to clear button
        if (floatingUndoBtn.style.display === 'flex') {
          floatingUndoBtn.style.display = 'none';
          floatingClearBtn.style.display = 'flex';
        }
        updateFloatingClearBtnVisibility();
      });
      el.addEventListener('change', () => {
        if (floatingUndoBtn.style.display === 'flex') {
          floatingUndoBtn.style.display = 'none';
          floatingClearBtn.style.display = 'flex';
        }
        updateFloatingClearBtnVisibility();
      });
    });

    // Initial visibility
    updateFloatingClearBtnVisibility();

    // Custom dropdown logic
    customDropdown.addEventListener('click', () => {
      dropdownOptions.style.display = dropdownOptions.style.display === 'none' ? 'block' : 'none';
    });

    dropdownOptions.addEventListener('mousedown', (e) => {
      let target = e.target;
      if (!target.classList.contains('dropdown-option')) {
        target = target.closest('.dropdown-option');
      }
      if (target) {
        const value = target.getAttribute('data-value');
        selectedOption.innerHTML = target.innerHTML;
        reasonInput.value = value;
        dropdownOptions.style.display = 'none';
        updateCustomReasonVisibility();
        updateNote();
        // Prevent focus/blur issues
        e.preventDefault();
      }
    });

    document.addEventListener('click', (e) => {
      if (!customDropdown.contains(e.target)) {
        dropdownOptions.style.display = 'none';
      }
    });

    customDropdown.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowDown' || e.key === 'Enter') {
        dropdownOptions.style.display = 'block';
        const first = dropdownOptions.querySelector('.dropdown-option');
        if (first) first.classList.add('active');
      }
    });

    // Initial note
    updateNote();
  </script>
</body>
</html>
